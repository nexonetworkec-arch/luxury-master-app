
{
  "rules": {
    /* üíé LUXURY MASTER SENTINEL RULES v3.0 - SECURITY HARDENED */
    
    // Solo admins definidos en el nodo /admins pueden leer todo el sistema
    ".read": "auth != null && root.child('admins').hasChild(auth.uid)",
    
    // Nadie puede escribir en la ra√≠z directamente desde el cliente, solo v√≠a Cloud Functions
    ".write": "false",

    "admins": {
      ".read": "auth != null",
      // Solo el servicio de backend o una cuenta ra√≠z inicial pueden escribir aqu√≠
      "$uid": {
        ".write": "false" 
      }
    },

    "global_messages": {
      "active": {
        ".read": "auth != null",
        // Solo admins pueden emitir mensajes globales
        ".write": "auth != null && root.child('admins').hasChild(auth.uid)",
        ".validate": "newData.hasChildren(['id', 'title', 'type', 'target'])"
      }
    },

    "global_configs": {
      "tiers": {
        ".read": "auth != null",
        ".write": "false"
      }
    },

    "licenses": {
      ".read": "auth != null && root.child('admins').hasChild(auth.uid)",
      "$key": {
        ".write": "false", // Generaci√≥n solo v√≠a Backend (/api/licenses/generate)
        "usedBy": {
          ".write": "auth != null && !data.exists()"
        }
      }
    },

    "users": {
      "$uid": {
        ".read": "auth != null && (auth.uid === $uid || root.child('admins').hasChild(auth.uid))",
        ".write": "auth != null && (auth.uid === $uid || root.child('admins').hasChild(auth.uid))",
        
        "config": {
          "level": {
            ".validate": "
              newData.val() === data.val() || 
              root.child('admins').hasChild(auth.uid) ||
              (newData.val() === 'free' && !data.exists())
            "
          }
        }
      }
    },

    "audit_master": {
      ".read": "auth != null && root.child('admins').hasChild(auth.uid)",
      ".write": "auth != null",
      "$logId": {
         ".validate": "newData.hasChildren(['event', 'timestamp', 'type', 'user'])"
      }
    }
  }
}
